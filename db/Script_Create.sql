CREATE TABLE TANQUE (
  TANQUE_ID INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  NOME VARCHAR(40) NOT NULL,
  TIPO_COMBUSTIVEL VARCHAR(20) NOT NULL,
  ESTOQUE_ATUAL_L DECIMAL(15,3) NOT NULL,
  VALOR_LITRO DECIMAL(15,4) DEFAULT 0
);

CREATE TABLE BOMBA (
  BOMBA_ID INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  TANQUE_ID INTEGER NOT NULL,
  CODIGO VARCHAR(20) NOT NULL,
  DESCRICAO VARCHAR(60),
  CONSTRAINT FK_BOMBA_TANQUE FOREIGN KEY (TANQUE_ID) REFERENCES TANQUE(TANQUE_ID)
);

CREATE TABLE CONFIGURACAO (
  CHAVE VARCHAR(50) PRIMARY KEY,
  VALOR DECIMAL(10,4) NOT NULL
);

CREATE TABLE ABASTECIMENTO (
  ABASTEC_ID INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  BOMBA_ID INTEGER NOT NULL,
  DATA_HORA TIMESTAMP NOT NULL,
  QUANTIDADE_LITROS DECIMAL(15,3) NOT NULL,
  VALOR_LITRO DECIMAL(15,4)  NOT NULL,
  VALOR_BRUTO DECIMAL(15,2) NOT NULL,
  VALOR_IMPOSTO DECIMAL(15,2) NOT NULL,
  CONSTRAINT FK_ABAST_BOMBA FOREIGN KEY (BOMBA_ID) REFERENCES BOMBA(BOMBA_ID)
);

SET TERM ^;
CREATE OR ALTER TRIGGER TRG_ABAST_BIU FOR ABASTECIMENTO
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
DECLARE VARIABLE V_TAXA NUMERIC(10,4);
BEGIN
  SELECT VALOR FROM CONFIGURACAO WHERE CHAVE='IMPOSTO_ABASTECIMENTO' INTO :V_TAXA;
  IF (V_TAXA IS NULL) THEN V_TAXA = 0.13;
  NEW.VALOR_IMPOSTO = NEW.VALOR_BRUTO * V_TAXA;
END^
SET TERM ;^
